<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for modules/auth/controllers/auth/loginController.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../../prettify.css" />
    <link rel="stylesheet" href="../../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../../index.html">all files</a> / <a href="index.html">modules/auth/controllers/auth/</a> loginController.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">8.57% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>3/35</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">8.57% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>3/35</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict';
&nbsp;
/**
 * Module dependencies
 */
const path = require('path'),
  config = require(path.resolve('config/config')),
  jwt = require('jsonwebtoken'),
  helper = require(path.resolve('common/helper')),
  async = require('async'),
  logger = require(path.resolve('lib/logger')),
  Boom = require(path.resolve('languages/en/errors')),
  User = require(path.resolve('models/User')),
  Session = require(path.resolve('models/Session'));
&nbsp;
/*
* 
* Function purpose :
    =&gt; Admin Or user login
    =&gt; Api can access by Admin or user
*/
exports.login = <span class="fstat-no" title="function not covered" >function (req, res, next) {</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  logger.logging('login', req);</span>
&nbsp;
  // define requested variable
<span class="cstat-no" title="statement not covered" >  var email = req.body.email.toLowerCase();</span>
<span class="cstat-no" title="statement not covered" >  var password = req.body.password;</span>
&nbsp;
  // Find user type base on request
<span class="cstat-no" title="statement not covered" >  var roll = '';</span>
<span class="cstat-no" title="statement not covered" >  var url = req.url.trim('/');</span>
<span class="cstat-no" title="statement not covered" >  if (url === '/api/auth/admin/login') {</span>
<span class="cstat-no" title="statement not covered" >    roll = 2; </span>// Admin
  } else <span class="cstat-no" title="statement not covered" >if (url === '/api/auth/user/login') {</span>
<span class="cstat-no" title="statement not covered" >    roll = 1; </span>// User
  } else {
<span class="cstat-no" title="statement not covered" >    return res.status(Boom.SOMETHING_WRONG.statusCode).json(Boom.SOMETHING_WRONG);</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  async.waterfall([</span>
<span class="fstat-no" title="function not covered" >    function(callback) {</span>
      // Check user exist or not
<span class="cstat-no" title="statement not covered" >      User.getUserByEmail(email, roll, <span class="fstat-no" title="function not covered" >function(err, results) {</span></span>
<span class="cstat-no" title="statement not covered" >        if (err) {</span>
<span class="cstat-no" title="statement not covered" >          callback(err);</span>
        } else <span class="cstat-no" title="statement not covered" >if (!results.length) {</span>
<span class="cstat-no" title="statement not covered" >          return res.status(Boom.INVALID_EMAIL.statusCode).json(Boom.INVALID_EMAIL);</span>
        } else {
<span class="cstat-no" title="statement not covered" >          callback(null, results[0]);</span>
        }
      });
    },
<span class="fstat-no" title="function not covered" >    function(user, callback) {</span>
      // Check password match
<span class="cstat-no" title="statement not covered" >      if (!helper.validPassword(password, user.password)) {</span>
<span class="cstat-no" title="statement not covered" >        return res.status(Boom.INVALID_CREDENTIAL.statusCode).json(Boom.INVALID_CREDENTIAL);</span>
      }
&nbsp;
      // return if user is blocked except admin
<span class="cstat-no" title="statement not covered" >      if (user.type !== 3) {</span>
        // User is blocked
<span class="cstat-no" title="statement not covered" >        if (user.status === 0) {</span>
<span class="cstat-no" title="statement not covered" >          return res.json(res.status(Boom.USER_BLOCKED.statusCode).USER_BLOCKED);</span>
        }
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      var tokenPayload = {</span>
        id: user.id,
        firstname: user.firstname,
        lastname: user.lastname,
        avatar: user.avatar,
        type: user.type
      }
&nbsp;
&nbsp;
      // Create json token and send to user
<span class="cstat-no" title="statement not covered" >      var result = {</span>
        id: user.id,
        firstname: user.firstname,
        lastname: user.lastname,
        avatar: user.avatar,
        token: jwt.sign(tokenPayload, config.key.privateKey, { expiresIn: config.key.tokenExpiry })
      };
&nbsp;
      // Decode token
<span class="cstat-no" title="statement not covered" >      var decoded = jwt.decode(result.token);</span>
&nbsp;
      // Prepare data for store in session
<span class="cstat-no" title="statement not covered" >      var data = {</span>
        user_id: user.id,
        token: result.token,
        created_time: decoded.iat,
        exp_time: decoded.exp,
        meta: tokenPayload,
      };
&nbsp;
      // Session.addMessage(false, user.id);
      // Store session data in database
<span class="cstat-no" title="statement not covered" >      Session.store(false, data, <span class="fstat-no" title="function not covered" >function (err) {</span></span>
<span class="cstat-no" title="statement not covered" >        if (err) {</span>
<span class="cstat-no" title="statement not covered" >          return res.status(Boom.SOMETHING_WRONG.statusCode).json(Boom.SOMETHING_WRONG);</span>
        } else {
<span class="cstat-no" title="statement not covered" >          return res.json({ status: 1, message: 'Logged in successfully.', result: result });</span>
        }
      });
    }
  ], <span class="fstat-no" title="function not covered" >function(err) {</span>
<span class="cstat-no" title="statement not covered" >    next(err);</span>
  });
&nbsp;
}; // End login
&nbsp;
&nbsp;
&nbsp;
/*
* 
* Function purpose :
    =&gt; Send success response if access token is valid
    =&gt; Api can access by all users
*/
exports.checkAuth = (req, res) =&gt; {
<span class="cstat-no" title="statement not covered" >  res.send({ status: 1, message: 'Success' });</span>
}; // End checkAuth
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Aug 13 2018 12:08:56 GMT+0530 (IST)
</div>
</div>
<script src="../../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../../sorter.js"></script>
</body>
</html>
